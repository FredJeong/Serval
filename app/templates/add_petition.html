{% extends "base.html" %}

{% block styles %}
{% endblock %}

{% block content %}
<style>
#items li{min-height: 40px;}
#items {padding-top: 10px;}
#items form *{margin-right: 5px;}
</style>
<h2>새 펀딩 만들기</h2>
<form id="petition_form">
    {{ form.csrf_token }}
    <div class="form-group">
        <label>{{form.title.label}}</label>
        {{form.title(class="form-control")}}
    </div>
    <div class="form-group">
        <label>{{form.content.label}}</label>
        {{form.content(class="form-control", rows=5)}}
    </div>

    <button class="btn btn-success" type="button" onclick="add_item_input()"><i class='fa fa-plus'></i> 추가</button>
    <ul class="list-unstyled" id="items">
    </ul>
    <button class="btn btn-primary" type="button" onclick="submit_form()">등록</button>
</form>
{% endblock %}

{% block scripts %}
<script src="//cdn.ckeditor.com/4.5.4/standard/ckeditor.js"></script>
<script type="text/javascript">
function add_item_input() {
    var html = 
        "<li><form class='form-inline'>" +
        "<div class='form-group'><label>상품명</label>" +
        "<input class='form-control' type='text' name='item_name'></input></div>" +
        "<div class='form-group'><label>가격</label>" +
        "<div class='input-group'><div class='input-group-addon'>&#8361;</div>" +
        "<input class='form-control' type='number' name='item_price'></input></div></div>" +
        "<button class='btn btn-danger' type='button' onclick='remove_item(this);'>" + 
        "<i class='fa fa-times'></i>" +
        "</button></li>";
    $("#items").append(html);
}

function remove_item(obj) {
    console.log(obj);
    $(obj).parent().parent().remove();
}

function submit_form() {
    var title = $("#title").val();
    var content = CKEDITOR.instances.content.getData();
    if (!title || title.trim() === "") {
        alert("제목을 입력해주세요.");
        return;
    }
    if (!content || content.trim() === "") {
        alert("내용을 입력해주세요.");
    }
    var items = [];
    var flag = true
    $("#items li").each(function(i, e) {
        var price = $(e).find("input[type=number]").val();
        var description = $(e).find("input[type=text]").val();
        if (!description || description.trim() === "") return true;
        if (!price || price.trim() === "") {
            alert(description + "의 가격을 입력해주세요.");
            flag = false;
            return false;
        }
        if (price < 0) {
            alert(description + "의 가격은 음수일 수 없습니다!");
            flag = false;
            return false;
        }
        items.push(price + "|" + description);
    });

    if(!flag) return;
    if(items.length === 0) {
        alert("최소 한 개의 상품을 입력해주세요.");
        return;
    }

    $.ajax({
        type: "POST",
        url: "/api/petition",
        data: {
            title: title,
            content: content,
            items: items
        },
        success: function(data) {
            console.log(data);
            location.href = "/petition/" + data.id;
        },
        error: function() {
            alert("Error occured while creating petition.");
        }
    });
}

add_item_input();
CKEDITOR.replace("content");

</script>
{% endblock %}